# Session 12+13+14 — 2026-02-19

## Session 12 (matin — terminee)
### Objectif
Suite session 11 : finaliser Telegram bot + n8n workflows avec notifications + deboguer n8n

### Actions
- Recupere chat_id Telegram `8585838701` via getUpdates
- Ajoute Telegram Code nodes aux workflows 02, 03, 04
- Resolu 5 bugs n8n (DB corrompue, credential MySQL, doublons workflows, MySQL timeout Docker, env vars denied)
- Cree API key n8n (legacy, stockee en clair)
- Watchdog execution #4 = SUCCESS
- Architecture OpenClaw-n8n documentee dans BRAIN/CLAW/architecture-openclaw-n8n.md

### Bugs resolus
1. n8n DB corrompue → supprime database.sqlite, recreer from scratch
2. Credential MySQL → `n8n import:credentials` CLI
3. Doublons workflows → sqlite3 DELETE + publish:workflow
4. MySQL timeout Docker → GRANT 172.% + UFW 172.16.0.0/12:3306
5. env vars denied → N8N_BLOCK_ENV_ACCESS_IN_NODE=false

---

## Session 13 (suite matin)
### Objectif
1. Fixer watchdog Check OpenRouter (faux positif DOWN)
2. Audit qualite donnees scraping
3. Planifier integration OpenClaw ↔ n8n

### Fix Watchdog Check OpenRouter
**Probleme** : `allItems[0]` et `allItems[1]` ordre non garanti quand 2 branches mergent.
**Fix** : `$('Check BDD').first().json` + `$('Check OpenRouter').first().json` + `continueOnFail: true`
**Resultat** : Execution #5 = SUCCESS

### Audit Qualite Donnees Scraping (896 estab)
| Champ | Completude |
|-------|-----------|
| name/address/GPS | 100% |
| phone | 53.3% |
| website | 18.5% |
| email | 5.1% |

0 doublons, 0 GPS hors Europe. 150 albergue, 98 restaurant, 72 epicerie...

### Exploration OpenClaw
- **Decouverte : OpenClaw n'orchestrait RIEN** — skills tournaient en nohup sur le host
- REST API `/hooks/agent` decouverte (meme port que WebSocket)
- Cron integre `config/cron/jobs.json`
- Plan d'integration valide : CLI via Execute Command

---

## Session 14 (apres-midi) — MIGRATION OPENCLAW
### Objectif
Migrer skills 01+06 de nohup standalone vers container OpenClaw. Securite d'abord.

### Etapes completees

#### 1. Securite (BRAIN/CLAW/SECURITY.md) ✅
- Regles de securite documentees : moindre privilege, no root, sandbox, API keys separees, logs, kill switch

#### 2. Documentation skills (BRAIN/CLAW/SKILLS-FORMAT.md) ✅
- Format SKILL.md avec frontmatter YAML, format cron, hooks, triggering

#### 3. Users MariaDB (4 agents) ✅
- `scribe_user` : SELECT/UPDATE localities, INSERT/UPDATE establishments + sources + scrape_jobs
- `batisseur_user` : SELECT + CREATE + INSERT/UPDATE locality_content + scrape_jobs
- `heraut_user` : SELECT * (lecture seule)
- `veilleur_user` : SELECT + INSERT scrape_jobs, quality_checks
- Tous avec hosts `localhost` + `172.%` (Docker)
- **Fix grants** : ajoute UPDATE localities pour scribe, CREATE pour batisseur (manquaient)

#### 4. Config OpenClaw ✅
- `hooks.enabled: true` + `hooks.token` dans openclaw.json
- `cron.enabled: true`
- extra_hosts `host.docker.internal:host-gateway` dans docker-compose
- mysql2 installe dans workspace container
- Hooks REST API testee et fonctionnelle

#### 5. Sync workspace ✅
- Supprime vieux `01-scrape-google/` du workspace VPS
- Copie `01-scrape-sonar/` + `06-enrichir-contenu/` du repo vers workspace
- Frontmatter YAML ajoute aux SKILL.md

#### 6. Cron jobs exec direct ✅
- Format `payload.kind: "exec"` — PAS `agentTurn` (evite LLM intermediaire payant)
- Skill 01 : `0 3 * * *` (3h Paris)
- Skill 06 : `0 4 * * *` (4h Paris)

#### 7. Switch Google AI Studio (Gemini 2.5 Flash) ✅
**Cause** : OpenRouter retourne `401: User not found` avec 3 cles differentes (cblrs-1, cblrs-2, cblrs-3). Probleme au niveau du compte, pas de la cle.

**Solution** : Dual-provider dans les skills
- `AI_PROVIDER=google` → `callGoogle()` : Gemini 2.5 Flash, gratuit
- `AI_PROVIDER=openrouter` → `callOpenRouter()` : Kimi K2.5 (fallback)
- Variable d'env dans docker-compose switch entre les deux
- Modele Gemini : `gemini-2.5-flash` (pas `preview-05-20`)
- Format Google : `systemInstruction` + `contents` + `responseMimeType: application/json`

#### 8. Securisation secrets ✅
**Incident** : Premiere cle Google (`AIzaSyAOtFdQS37QBqViWpWi1dPU-35N34r71Ss`) pushee dans docker-compose.yml sur GitHub public → Google l'a flag "leaked" en quelques minutes.

**Fix** :
- Cree `/data/openclaw/.env` sur VPS (chmod 600) avec tous les secrets
- docker-compose utilise `env_file: /data/openclaw/.env`
- **Plus AUCUN secret dans les fichiers git** (passwords DB, API keys)
- Ancienne cle Google leaked supprimee, nouvelle cle fonctionnelle

#### 9. Nohup arretes ✅
- Kill des 4 processus nohup sur le host
- Skills tournent maintenant UNIQUEMENT dans le container OpenClaw

### Incidents session 14

| Incident | Cause | Resolution |
|----------|-------|-----------|
| OpenRouter 401 "User not found" | Compte OpenRouter bloque | Switch vers Google AI Studio |
| Google API key leaked | Pushee dans docker-compose git | `.env` gitignored, chmod 600 |
| Grants DB manquants | UPDATE localities + CREATE manquants | GRANT supplementaires |
| Modele Gemini 404 | `preview-05-20` n'existe pas | Remplace par `gemini-2.5-flash` |
| `set -e` + bad substitution | `${VAR:0:10}` non supporte dans sh | Retire set -e |
| Cron jobs vides | Format JSON incorrect (array vs object) | `{"version":1,"jobs":[...]}` |

### Donnees fin de session 14
| Metrique | Debut session | Fin session |
|----------|--------------|-------------|
| establishments | 896 | 1077 |
| locality_content | 152 | 233 |
| loc done | 35 | 81 |
| loc error | 0 | 2271 (API key mortes) → reset pending |
| Skills mode | nohup host | Container OpenClaw |
| AI Provider | Kimi K2.5 (OpenRouter) | Gemini 2.5 Flash (Google) |

### Etat fin de session
- **Skills 01 + 06 EN COURS** dans container OpenClaw avec Gemini 2.5 Flash
- 2275 localites pending (reset des erreurs API)
- `.env` securise, docker-compose propre
- Cron jobs configures (3h + 4h Paris, exec direct)
- OpenRouter inutilisable pour l'instant

### Prochaines etapes
1. **Connecter n8n a OpenClaw** (tache 5) : SSH node, NODES_EXCLUDE, workflow 04 restart
2. Resoudre OpenRouter (contacter support ?)
3. Surveiller progression scraping Gemini
4. Implementer skills 02-08
