# Session 12 — 2026-02-19

## Objectif
Suite session 11 : finaliser Telegram bot + n8n workflows avec notifications + deboguer n8n

## Actions

### Telegram Bot
- Recupere chat_id `8585838701` via getUpdates (user Gero Nimo, /start recu)
- Mis a jour BRAIN/CREDENTIALS avec chat_id
- Envoye message test reussi : "Bot connecte ! Scraping en cours..."
- Ajoute TELEGRAM_BOT_TOKEN + TELEGRAM_CHAT_ID dans /data/n8n/.env

### N8N Workflows — Telegram integre
- Workflow 02 (QC 06h00) : ajoute node "Envoyer Telegram QC" — score qualite + issues + recommandations
- Workflow 03 (Rapport 07h00) : ajoute node "Envoyer Telegram" — rapport complet avec KPI et emojis
- Workflow 04 (Watchdog 15min) : ajoute node "Alerte Telegram" — envoie SEULEMENT si WARNING ou CRITICAL
- Tous les nodes Telegram utilisent Code nodes avec fetch() vers api.telegram.org

### N8N — Problemes resolus (5 bugs)
1. **DB corrompue** : "Set up owner account" puis "No workspace here" → user shell vide avec isInstanceOwnerSetUp=false. Fix : supprime database.sqlite, laisse n8n recreer from scratch
2. **Credential MySQL** : Cree via `n8n import:credentials` (CLI chiffre les donnees). ID = a1b2c3d4-mysql-cblrs-staging, lie au projet owner
3. **Doublons workflows** : Import creait des copies. Fix : sqlite3 DELETE + publish:workflow + restart
4. **MySQL timeout depuis Docker** : staging_user autorise seulement localhost. Fix : GRANT depuis 172.% + UFW allow 172.16.0.0/12:3306
5. **"access to env vars denied"** : n8n 2.8 task runner bloque $env dans Code nodes. Fix : `N8N_BLOCK_ENV_ACCESS_IN_NODE=false` dans docker-compose

### N8N — Configuration finale
- docker-compose : extra_hosts (host.docker.internal), env_file (/data/n8n/.env), N8N_BLOCK_ENV_ACCESS_IN_NODE=false
- API key creee : n8n_api_429a... (legacy format, stockee en clair dans user_api_keys, utilisable avec X-N8N-API-KEY header)
- Credential MySQL : host=host.docker.internal, user=staging_user, db=caballarius_staging
- 4 workflows importes, publies, actifs — watchdog teste et SUCCESS (execution #4)

### Architecture OpenClaw-n8n
- Cree BRAIN/CLAW/architecture-openclaw-n8n.md
- 4 agents documentes : Le Scribe, Le Batisseur, Le Heraut, Le Veilleur
- Schema d'integration complet (Docker, MariaDB, OpenRouter, Telegram)

### State BDD (08h)
- locality_content : 131 rows (45 localites enrichies)
- establishments : 754 rows (31 localites scrapees)
- Les 2 skills tournent normalement (4 processus actifs)

## Etat scraping nuit (progression)
| Metrique | 07h00 | 08h00 | Progression |
|----------|-------|-------|-------------|
| locality_content | 47 | 131 | +84 |
| establishments | 109 | 754 | +645 |
| loc enrichies | 17 | 45 | +28 |
| loc scrapees | 8 | 31 | +23 |

## Bugs connus ajoutes a la memoire
- n8n 2.8 : API keys = JWT ou legacy (n8n_api_), stockees en CLAIR dans SQLite
- n8n 2.8 : N8N_BLOCK_ENV_ACCESS_IN_NODE=false requis pour $env dans Code nodes
- n8n 2.8 : publish:workflow necessaire apres import pour activer les crons
- n8n 2.8 : delete:workflow n'existe pas en CLI, utiliser sqlite3 directement
- MySQL depuis Docker : GRANT user@'172.%' + UFW allow 172.16.0.0/12

## Prochaines etapes
1. Surveiller qualite des donnees apres 24h de scraping
2. Tester workflows 02 (QC) et 03 (Rapport) manuellement
3. Ajuster le Check OpenRouter node (retourne trop de donnees, faussement detecte comme DOWN)
4. Implementer les skills restants (02-05, 07-08)
5. Semaine prochaine : Sonar Pro en 2eme passe
