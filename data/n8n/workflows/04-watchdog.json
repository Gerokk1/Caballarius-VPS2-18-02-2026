{
  "name": "Caballarius - Watchdog",
  "nodes": [
    {
      "name": "Cron 30min",
      "type": "n8n-nodes-base.cron",
      "position": [250, 300],
      "parameters": {
        "triggerTimes": { "item": [{ "mode": "everyX", "value": 30, "unit": "minutes" }] }
      }
    },
    {
      "name": "Check OpenClaw",
      "type": "n8n-nodes-base.executeCommand",
      "position": [450, 200],
      "parameters": {
        "command": "docker ps --filter name=openclaw-bunker --format '{{.Status}}' | grep -q 'Up' && echo 'UP' || echo 'DOWN'"
      }
    },
    {
      "name": "Check Stuck Jobs",
      "type": "n8n-nodes-base.mySql",
      "position": [450, 400],
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, job_type, target_type, target_id, started_at FROM scrape_jobs WHERE status = 'running' AND started_at < NOW() - INTERVAL 1 HOUR"
      }
    },
    {
      "name": "Check Disk",
      "type": "n8n-nodes-base.executeCommand",
      "position": [450, 600],
      "parameters": {
        "command": "df -h /data | tail -1 | awk '{print $5}' | sed 's/%//'"
      }
    },
    {
      "name": "Check OpenRouter",
      "type": "n8n-nodes-base.httpRequest",
      "position": [450, 800],
      "parameters": {
        "method": "GET",
        "url": "https://openrouter.ai/api/v1/models",
        "options": { "timeout": 5000 }
      }
    },
    {
      "name": "Process Alerts",
      "type": "n8n-nodes-base.code",
      "position": [700, 400],
      "parameters": {
        "jsCode": "const alerts = [];\n\n// OpenClaw down?\nconst clawStatus = $node['Check OpenClaw'].json.stdout?.trim();\nif (clawStatus !== 'UP') alerts.push('CRITICAL: OpenClaw container DOWN!');\n\n// Stuck jobs?\nconst stuckJobs = $node['Check Stuck Jobs'].json;\nif (stuckJobs && stuckJobs.length > 0) {\n  for (const j of stuckJobs) alerts.push(`WARNING: Job #${j.id} (${j.job_type}) stuck since ${j.started_at}`);\n}\n\n// Disk full?\nconst diskUsage = parseInt($node['Check Disk'].json.stdout?.trim() || '0');\nif (diskUsage > 80) alerts.push(`WARNING: Disk usage ${diskUsage}%`);\nif (diskUsage > 95) alerts.push(`CRITICAL: Disk almost full ${diskUsage}%!`);\n\n// OpenRouter down?\nconst orStatus = $node['Check OpenRouter'].json?.statusCode;\nif (orStatus !== 200) alerts.push('WARNING: OpenRouter API not responding');\n\nif (alerts.length === 0) return [{json: {status: 'OK', message: 'All systems nominal'}}];\nreturn alerts.map(a => ({json: {status: 'ALERT', message: a}}));"
      }
    },
    {
      "name": "Fix Stuck Jobs",
      "type": "n8n-nodes-base.mySql",
      "position": [700, 600],
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE scrape_jobs SET status = 'error', error_log = 'Timeout: stuck > 1 hour, marked by watchdog' WHERE status = 'running' AND started_at < NOW() - INTERVAL 1 HOUR"
      }
    },
    {
      "name": "Alert Telegram",
      "type": "n8n-nodes-base.telegram",
      "position": [900, 400],
      "parameters": {
        "chatId": "{{$credentials.telegramChatId}}",
        "text": "ðŸš¨ WATCHDOG ALERT\n{{ $json.message }}"
      }
    }
  ],
  "connections": {
    "Cron 30min": { "main": [[ { "node": "Check OpenClaw" }, { "node": "Check Stuck Jobs" }, { "node": "Check Disk" }, { "node": "Check OpenRouter" } ]] },
    "Check OpenClaw": { "main": [[ { "node": "Process Alerts" } ]] },
    "Check Stuck Jobs": { "main": [[ { "node": "Process Alerts" }, { "node": "Fix Stuck Jobs" } ]] },
    "Check Disk": { "main": [[ { "node": "Process Alerts" } ]] },
    "Check OpenRouter": { "main": [[ { "node": "Process Alerts" } ]] },
    "Process Alerts": { "main": [[ { "node": "Alert Telegram" } ]] }
  }
}
